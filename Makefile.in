SHELL = /bin/sh

withdebug=0
withcuda=1

cputype = $(shell uname -m | sed "s/\\ /_/g")
systype = $(shell uname -s)
commit = $(shell git rev-parse HEAD)

ifeq ($(systype), Darwin)
withcuda=0
CXX = clang++
OPTFLAGS = -stdlib=libc++ -march=native -O3 -funroll-loops
COPTIONS = -Wall -DDarwin
CUDA = /usr/local/cuda/bin/nvcc
CUDAOPTS = -O3 -DNDEBUG -DCUDA \
					 -gencode=arch=compute_20,code=sm_20 \
					 -gencode=arch=compute_20,code=compute_20 \
					 -gencode=arch=compute_35,code=sm_35 \
		       -gencode=arch=compute_35,code=compute_35
else
CXX = icc
OPTFLAGS = -openmp -march=native -O3 -funroll-loops
COPTIONS = -Wall -DLinux -DMKL -m64
CUDA = /usr/local/cuda/bin/nvcc
CUDAOPTS = -O3 -DNDEBUG -DCUDA \
					 -gencode=arch=compute_30,code=sm_30
endif

# Linker information
LDOPTIONS =
LD = $(CXX)

# Compile input/output file specification
SOURCEFILE = -c $<
OUTPUTFILE = -o $@

# Output specification for executables
EXEOUTPUTFILE = -o $@

#----------------------------------------------------------------------
# Build specific options
#----------------------------------------------------------------------

OPTFLAGS += -DGITCOMMIT=$(commit)

ifeq ($(withdebug), 1)
	OPTFLAGS = -pg -g -DDEBUG -O1 #-stdlib=libc++
	LDOPTIONS += -g
else
	OPTFLAGS += -DNDEBUG	# turn off asserts
endif

ifeq ($(withcuda), 1)
	OPTFLAGS += -DCUDA
endif

LIBCONFIGDIR = ./libconfig
#MKLROOT = /opt/intel/Compiler/11.1/059/mkl

INCLUDES = -I$(TOPDIR) -I/sfw/libconfig-1.4.9/include -I/usr/local/cuda/include -I$(MKLROOT)/include
CFLAGS:=$(COPTIONS) $(OPTFLAGS) $(INCLUDES)

MKLroot = /opt/intel/Compiler/11.1/059/mkl/lib/em64t

ifeq ($(withcuda), 1)
	ifeq ($(cputype), x86_64)
		ifeq ($(systype), Darwin)
			LIBSDIR = -L/usr/local/cuda/lib
		else
			LIBSDIR = -L/usr/local/cuda/lib64
		endif
	else
		LIBSDIR = -L/usr/local/cuda/lib
	endif
		LIBS = -L/usr/local/cuda/lib -lcudart -lcurand  -lcublas -lcusparse
endif

#LIBS += -L/sfw/libconfig-1.4.9/lib -lfftw3 /usr/local/lib/libconfig++.a

ifeq ($(systype), Darwin)
LIBS += -L/sfw/libconfig-1.4.9/lib -lfftw3 /usr/local/lib/libconfig++.a
else
LIBS += -L/sfw/libconfig-1.4.9/lib -lfftw3 /usr/local/lib/libconfig++.a -L$(MKLROOT)/lib/intel64 -lmkl_intel_lp64 -lmkl_core -lmkl_sequential -lpthread -lm
endif

LDFLAGS = $(LIBSDIR)  
